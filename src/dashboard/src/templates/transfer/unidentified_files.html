{% extends "layout_fluid.html" %}
{% load breadcrumb %}

{% block extra_css %}
  <link href="{{ STATIC_URL }}vendor/datatables/css/jquery.dataTables.css" rel="stylesheet">
{% endblock %}

{% block js %}
<script type="text/javascript" src="{{ STATIC_URL }}vendor/datatables/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}vendor/readmore.min.js"></script>

<script type="text/javascript">
  $(document).ready(function()
  {
    function render_stderror_col(stderror, type, row_data) {
      return '<pre class="stderror-col">' + stderror + '</pre>';
    }

    var cols = [
      {sTitle: 'Filename', mData: 'filename'},
      {sTitle: 'STDERR', mData: 'stderror', mRender: render_stderror_col},
      {sTitle: 'Enter PUID manually', mData: null},
      {sTitle: 'Submit to PRONOM', mData: null}
    ];

    function get_file_data(format) {
        return $('#files-table').dataTable({
          'bLengthChange': false,
          'bFilter': false,
          'bAutoWidth': false,
          'sPaginationType': 'full_numbers',
          'bServerSide': true,
          'sAjaxSource': '/transfer/get_unidentified_files/{{ uuid }}?fmt=' + format,
          'aoColumns': cols,
          'iDisplayLength': 5,
          'fnServerData': function(sSource, aoData, fnCallback) {
            $.getJSON(sSource, aoData, function(json) {
              fnCallback(json);

              $('.stderror-col').readmore({
                collapsedHeight: 45
              });
            });
          },
        });
    }

    var dtable = null;

    $.ajax({
        method: 'GET',
        url: '/transfer/get_unidentified_file_formats/{{ uuid }}',
        data: { uuid: '{{ uuid }}' },
        success: function(data) {
            var first = true;
            $.each(data, function(key, value) {
                var li_dom = '<li><a href="#">' + (key ? key : 'No extension') +
                             ': ' + value + '</a></li>';

                var li_fmt = $(li_dom).addClass('extension')
                                      .attr('data-fmt', key);

                if (first) {
                    first = false;
                    $(li_fmt).addClass('active');
                    dtable = get_file_data(key);
                }

                $('#file-formats').append(
                    li_fmt
                );

                $(li_fmt).click(function() {
                    $('.extension').removeClass('active');
                    $(this).addClass('active');

                    dtable.fnDestroy();
                    dtable = get_file_data($(this).attr('data-fmt'));
                });
            });
        }
    });
  });
</script>
{% endblock %}

{% block content %}
    <div>
        Total files in transfer: {{ total_file_count }}<br>
        Total unidentified files: {{ unidentified_file_count }}<br>
    </div>


    <div>
        <ul id="file-formats" class="pills">

        </ul>
    </div>

    <table id="files-table">
    </table>

    <br>
    Re-identify selected files with:
    <select>
      {% for item in tool_choices %}
        <option value="{{ item.0 }}">{{ item.1 }}</option>
      {% endfor %}
    </select>
{% endblock %}
